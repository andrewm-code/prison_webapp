<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One-Sentence Prison</title>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            font-size: 14px;
            background-color: #ffffff;
            color: #000000;
            margin: 20px;
            line-height: 1.4;
            position: relative;
            overflow-x: hidden;
        }

        h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: #000080;
        }

        .subtitle {
            text-align: center;
            font-size: 12px;
            color: #666666;
            margin-bottom: 20px;
            font-style: italic;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #cccccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            border: 1px solid #cccccc;
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        .btn {
            border: 2px outset #cccccc;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
            border-radius: 3px;
            background-color: #cccccc;
        }

        .btn:active {
            border: 2px inset #cccccc;
        }

        .btn:disabled {
            background-color: #f0f0f0;
            color: #999999;
            cursor: not-allowed;
        }

        .copy-btn {
            background-color: #ccffcc;
        }

        .copy-btn:active {
            border: 2px inset #ccffcc;
        }

        .goals-section {
            background-color: #fff0e6;
            border: 1px solid #ffcc99;
            padding: 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .goals-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .goal-inputs {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .goal-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #999999;
            font-family: 'Times New Roman', serif;
            text-align: center;
        }

        .completed-sentences {
            width: 100%;
            min-height: 150px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px inset #cccccc;
            padding: 15px;
            background-color: #f9f9f9;
            font-family: 'Comic Sans MS', cursive;
            font-size: 14px;
            line-height: 1.6;
            box-sizing: border-box;
        }

        .sentence-span {
            transition: opacity 0.5s ease;
        }

        .text-block {
            transition: opacity 0.3s ease;
        }

        .text-block.visible {
            opacity: 1;
        }

        .text-block.typewriter-mode {
            opacity: 0.2;
        }

        .current-sentence {
            background-color: #ffffcc;
            padding: 2px 4px;
            border-radius: 3px;
        }

        #currentSentence {
            width: 100%;
            height: 80px;
            border: 2px inset #cccccc;
            padding: 15px;
            font-family: 'Comic Sans MS', cursive;
            font-size: 16px;
            background-color: #ffffff;
            resize: none;
            box-sizing: border-box;
            margin-top: 10px;
        }

        #currentSentence:focus {
            background-color: #ffffcc;
            outline: none;
        }

        .stats {
            padding: 10px;
            border: 1px solid #cccccc;
            background-color: #f8f8f8;
            font-size: 12px;
            text-align: center;
            border-radius: 5px;
        }

        .instructions {
            background-color: #e6f3ff;
            border: 1px solid #99ccff;
            padding: 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .timer-display {
            font-weight: bold;
            color: #0066cc;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #4da6ff;
            transition: width 0.3s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            background-color: #4da6ff;
            color: white;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            font-size: 14px;
        }

        .notification.show {
            opacity: 1;
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #ff6b6b;
            animation: confetti-fall 3s linear forwards;
            z-index: 5;
            pointer-events: none;
        }

        .confetti:nth-child(odd) {
            background-color: #4ecdc4;
            animation-delay: -0.5s;
        }

        .confetti:nth-child(3n) {
            background-color: #45b7d1;
            animation-delay: -1s;
        }

        .confetti:nth-child(4n) {
            background-color: #f9ca24;
            animation-delay: -1.5s;
        }

        .confetti:nth-child(5n) {
            background-color: #f0932b;
            animation-delay: -2s;
        }

        .confetti:nth-child(6n) {
            background-color: #eb4d4b;
            animation-delay: -2.5s;
        }

        .confetti:nth-child(7n) {
            background-color: #6c5ce7;
            animation-delay: -1.2s;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        hr {
            margin: 25px 0;
            border: 0;
            border-top: 1px solid #cccccc;
        }

        .footer {
            text-align: center;
            font-size: 11px;
            color: #666666;
            margin-top: 20px;
        }

        .keyboard-shortcuts {
            font-size: 10px;
            color: #999999;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <h1>One-Sentence Prison</h1>
    <p class="subtitle">"Every sentence is a step forward, no looking back."</p>
    
    <div class="container">
        <div class="instructions section">
            <strong>Rules:</strong> Write one sentence at a time. Complete sentences with periods, exclamation points, or question marks followed by a space. 
            You can only see your most recent sentence until you click "Finish". No editing completed sentences!
            <div class="keyboard-shortcuts">
                <strong>Shortcuts:</strong> Ctrl+Enter (Finish), Ctrl+C (Copy), Ctrl+S (Save)
            </div>
        </div>

        <div class="goals-section section">
            <div class="goals-row">
                <strong>Goals:</strong>
                <div class="goal-inputs">
                    <label>Sentences: <input type="number" class="goal-input" id="sentenceGoal" value="10" min="1"></label>
                    <label>Words: <input type="number" class="goal-input" id="wordGoal" value="100" min="1"></label>
                    <label>Time (min): <input type="number" class="goal-input" id="timeGoal" value="15" min="1"></label>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div>Progress: <span id="progressText">0%</span> | Session time: <span class="timer-display" id="sessionTimer">00:00</span></div>
        </div>

        <div class="controls">
            <button class="btn" onclick="finishWriting()">Finish & Reveal All</button>
            <button class="btn copy-btn" id="copyBtn" onclick="copyText()" disabled>Copy Text</button>
            <button class="btn" onclick="saveSession()">Save</button>
            <button class="btn" onclick="loadSession()">Load</button>
        </div>

        <div class="completed-sentences" id="completedSentences">
            <em style="color: #999;">Your completed sentences will appear here...</em>
        </div>
        
        <textarea 
            id="currentSentence" 
            placeholder="Start writing your sentence here..."
        ></textarea>
        
        <div class="stats section">
            Sentences: <strong id="sentenceCount">0</strong> | 
            Total words: <strong id="wordCount">0</strong> | 
            Current words: <strong id="currentWords">0</strong> |
            Streak: <strong id="streakCount">0</strong> days
        </div>
    </div>

    <hr>
    <div class="footer">
        <em>Focus on one sentence at a time.</em>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        var currentSentenceInput = document.getElementById('currentSentence');
        var completedSentencesDiv = document.getElementById('completedSentences');
        var sentenceCountSpan = document.getElementById('sentenceCount');
        var wordCountSpan = document.getElementById('wordCount');
        var currentWordsSpan = document.getElementById('currentWords');
        var streakCountSpan = document.getElementById('streakCount');
        var copyBtn = document.getElementById('copyBtn');
        var progressFill = document.getElementById('progressFill');
        var progressText = document.getElementById('progressText');
        var sessionTimer = document.getElementById('sessionTimer');
        
        var completedSentences = [];
        var isFinished = false;
        var totalWords = 0;
        var sessionStartTime = Date.now();
        var timerInterval = null;
        var soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        var goalAchieved = false; // Track if goal has been achieved

        // Confetti celebration
        function createConfetti() {
            var colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
            var confettiCount = 150;
            
            for (var i = 0; i < confettiCount; i++) {
                var confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = (Math.random() * 3) + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                // Randomize confetti shapes
                if (Math.random() > 0.5) {
                    confetti.style.borderRadius = '50%';
                } else {
                    confetti.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
                }
                
                document.body.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(function(element) {
                    if (element && element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                }, 5000, confetti);
            }
        }

        // Calculate progressive opacity for sentences
        function calculateOpacity(index, totalSentences) {
            if (isFinished) {
                return 1; // All sentences fully visible when finished
            }
            
            // In typewriter mode, apply progressive fading
            var position = totalSentences - index; // Position from end (1 = most recent)
            
            if (position === 1) {
                return 1; // Most recent sentence fully visible
            } else if (position === 2) {
                return 0.7; // Second most recent
            } else if (position === 3) {
                return 0.4; // Third most recent
            } else if (position === 4) {
                return 0.2; // Fourth most recent
            } else {
                return 0.1; // Older sentences almost invisible
            }
        }

        // Session timer
        function startTimer() {
            sessionStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            var elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            var minutes = Math.floor(elapsed / 60);
            var seconds = elapsed % 60;
            sessionTimer.textContent = 
                (minutes < 10 ? '0' : '') + minutes + ':' + 
                (seconds < 10 ? '0' : '') + seconds;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Goal tracking and progress
        function updateProgress() {
            var sentenceGoal = parseInt(document.getElementById('sentenceGoal').value) || 10;
            var wordGoal = parseInt(document.getElementById('wordGoal').value) || 100;
            var timeGoal = parseInt(document.getElementById('timeGoal').value) || 15;
            
            var currentText = currentSentenceInput.value.trim();
            var currentWordCount = currentText === '' ? 0 : currentText.split(/\s+/).length;
            var totalCurrentWords = totalWords + currentWordCount;
            
            var sentenceProgress = (completedSentences.length / sentenceGoal) * 100;
            var wordProgress = (totalCurrentWords / wordGoal) * 100;
            var timeElapsed = Math.floor((Date.now() - sessionStartTime) / 60000);
            var timeProgress = (timeElapsed / timeGoal) * 100;
            
            var overallProgress = Math.min(100, (sentenceProgress + wordProgress + timeProgress) / 3);
            
            progressFill.style.width = overallProgress + '%';
            progressText.textContent = Math.round(overallProgress) + '%';
            
            // Check if goals are achieved for the first time
            if (overallProgress >= 100 && !isFinished && !goalAchieved) {
                goalAchieved = true;
                createConfetti();
                playSound('success');
                showNotification('🎉 Congratulations! You\'ve reached your goals!');
            }
        }

        // Sound feedback
        function playSound(type) {
            if (!soundEnabled) return;
            
            try {
                var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                var oscillator = audioCtx.createOscillator();
                var gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                if (type === 'complete') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                } else if (type === 'success') {
                    oscillator.frequency.value = 1000;
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                }
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch (e) {
                // Audio context not supported
            }
        }

        // Notification system
        function showNotification(message) {
            var notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(function() {
                notification.classList.remove('show');
            }, 3000);
        }

        // Save/Load functionality
        function saveSession() {
            var sessionData = {
                sentences: completedSentences,
                totalWords: totalWords,
                startTime: sessionStartTime,
                currentSentence: currentSentenceInput.value,
                goalAchieved: goalAchieved,
                timestamp: Date.now()
            };
            localStorage.setItem('sentencePrisonSession', JSON.stringify(sessionData));
            showNotification('Session saved!');
        }

        function loadSession() {
            var saved = localStorage.getItem('sentencePrisonSession');
            if (saved) {
                var sessionData = JSON.parse(saved);
                completedSentences = sessionData.sentences || [];
                totalWords = sessionData.totalWords || 0;
                sessionStartTime = sessionData.startTime || Date.now();
                goalAchieved = sessionData.goalAchieved || false;
                currentSentenceInput.value = sessionData.currentSentence || '';
                
                displaySentences();
                updateStats();
                updateProgress();
                startTimer();
                showNotification('Session loaded!');
            } else {
                showNotification('No saved session found');
            }
        }

        // Streak tracking
        function updateStreak() {
            var today = new Date().toDateString();
            var lastWriteDate = localStorage.getItem('lastWriteDate');
            var currentStreak = parseInt(localStorage.getItem('writingStreak')) || 0;
            
            if (lastWriteDate !== today) {
                var yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastWriteDate === yesterday.toDateString()) {
                    currentStreak++;
                } else if (lastWriteDate !== today) {
                    currentStreak = 1;
                }
                
                localStorage.setItem('lastWriteDate', today);
                localStorage.setItem('writingStreak', currentStreak);
            }
            
            streakCountSpan.textContent = currentStreak;
        }

        // Copy functionality
        function copyText() {
            if (completedSentences.length === 0) {
                showNotification('No text to copy');
                return;
            }
            
            var text = completedSentences.join(' ');
            navigator.clipboard.writeText(text).then(function() {
                showNotification('Text copied to clipboard!');
            }).catch(function() {
                // Fallback for older browsers
                var textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Text copied to clipboard!');
            });
        }

        // Reset goal achievement when goals change
        document.getElementById('sentenceGoal').addEventListener('change', function() {
            goalAchieved = false;
            updateProgress();
        });

        document.getElementById('wordGoal').addEventListener('change', function() {
            goalAchieved = false;
            updateProgress();
        });

        document.getElementById('timeGoal').addEventListener('change', function() {
            goalAchieved = false;
            updateProgress();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        finishWriting();
                        break;
                    case 'c':
                        if (isFinished) {
                            e.preventDefault();
                            copyText();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        saveSession();
                        break;
                }
            }
        });

        function updateStats() {
            var currentText = currentSentenceInput.value.trim();
            var currentWordCount = currentText === '' ? 0 : currentText.split(/\s+/).length;
            
            sentenceCountSpan.textContent = completedSentences.length;
            wordCountSpan.textContent = totalWords + currentWordCount;
            currentWordsSpan.textContent = currentWordCount;
            
            updateProgress();
            updateStreak();
        }

        function displaySentences() {
            if (completedSentences.length === 0) {
                completedSentencesDiv.innerHTML = '<em style="color: #999;">Your completed sentences will appear here...</em>';
                return;
            }

            var html = '';
            
            if (isFinished) {
                // Show all sentences fully visible when finished
                html = '<div class="text-block visible">' + completedSentences.join(' ') + '</div>';
            } else {
                // Typewriter mode with progressive transparency
                html = '<div class="text-block visible">';
                
                completedSentences.forEach(function(sentence, index) {
                    var opacity = calculateOpacity(index, completedSentences.length);
                    var isCurrentSentence = (index === completedSentences.length - 1);
                    
                    if (isCurrentSentence) {
                        html += '<span class="sentence-span current-sentence" style="opacity: ' + opacity + '">' + sentence + '</span>';
                    } else {
                        html += '<span class="sentence-span" style="opacity: ' + opacity + '">' + sentence + '</span>';
                    }
                    
                    // Add space between sentences
                    if (index < completedSentences.length - 1) {
                        html += ' ';
                    }
                });
                
                html += '</div>';
            }
            
            completedSentencesDiv.innerHTML = html;
            completedSentencesDiv.scrollTop = completedSentencesDiv.scrollHeight;
        }

        function completeSentence() {
            var text = currentSentenceInput.value.trim();
            if (text.length > 0) {
                // Handle multiple sentence endings: . ! ? and with optional quotes
                var sentence = text.replace(/[.!?]["']?\s*$/, '').trim();
                
                // Add appropriate ending based on what was detected
                var originalEnding = text.match(/[.!?]["']?\s*$/);
                if (originalEnding) {
                    var ending = originalEnding[0].trim();
                    sentence += ending;
                } else {
                    sentence += '.';
                }
                
                completedSentences.push(sentence);
                
                var wordsInSentence = sentence.split(/\s+/).length;
                totalWords += wordsInSentence;
                
                currentSentenceInput.value = '';
                
                displaySentences();
                updateStats();
                playSound('complete');
                
                currentSentenceInput.focus();
            }
        }

        function finishWriting() {
            var currentText = currentSentenceInput.value.trim();
            if (currentText.length > 0 && !currentText.match(/[.!?]["']?\s*$/)) {
                var sentence = currentText + (currentText.match(/[.!?]["']?$/) ? '' : '.');
                completedSentences.push(sentence);
                var wordsInSentence = sentence.split(/\s+/).length;
                totalWords += wordsInSentence;
                currentSentenceInput.value = '';
            }
            
            isFinished = true;
            displaySentences();
            updateStats();
            stopTimer();
            currentSentenceInput.disabled = true;
            currentSentenceInput.placeholder = "Writing session completed. Click Copy to get your text.";
            copyBtn.disabled = false;
            showNotification('Writing session completed!');
        }

        // Event listeners
        currentSentenceInput.addEventListener('input', function() {
            var text = this.value;
            updateStats();
            
            // Check for sentence endings: . ! ? followed by space, with optional quotes
            if (text.match(/[.!?]["']?\s$/)) {
                completeSentence();
            }
        });

        currentSentenceInput.addEventListener('keydown', function(e) {
            updateStats();
        });

        // Initialize
        updateStats();
        startTimer();
        currentSentenceInput.focus();
    </script>
</body>
</html>
